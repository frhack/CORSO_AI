<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dx â€” Preferenze Vacanziere (cosine similarity)</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0d1117; color: #c9d1d9;
    min-height: 100vh;
}
.controls { display: flex; gap: 8px; align-items: center; }
button {
    background: #238636; color: #fff; border: none; border-radius: 6px;
    padding: 7px 20px; font-size: 13px; font-weight: 600; cursor: pointer;
    transition: background 0.15s;
}
button:hover { background: #2ea043; }
button:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
main {
    display: grid; grid-template-columns: 480px 1fr;
    height: 100vh;
}
@media (max-width: 900px) {
    main { grid-template-columns: 1fr; }
    .code-panel { max-height: 40vh; }
}
.code-panel {
    border-right: 1px solid #21262d; overflow: auto; padding: 0;
    background: #0d1117; display: flex; flex-direction: column;
}
.panel-header {
    font-size: 12px; color: #8b949e; text-transform: uppercase;
    letter-spacing: 1px; padding: 12px 16px 8px;
    border-bottom: 1px solid #21262d; background: #161b22;
    display: flex; align-items: center; gap: 10px;
}
.panel-header .title { flex: 1; }
.badge {
    display: inline-block; padding: 2px 8px; border-radius: 10px;
    font-size: 10px; font-weight: 600; letter-spacing: 0.5px;
}
.badge-live { background: #1f6feb33; color: #58a6ff; }
.editor-wrap {
    position: relative; width: 100%; flex: 1;
    overflow: hidden;
}
.editor-wrap pre, .editor-wrap textarea {
    font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Menlo', 'Consolas', monospace;
    font-size: 13px; line-height: 1.5; padding: 12px 16px;
    tab-size: 4; margin: 0; border: none; outline: none;
    white-space: pre; overflow: auto;
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
}
.editor-highlight {
    background: #0d1117; color: #c9d1d9; pointer-events: none; z-index: 0;
}
.editor-textarea {
    background: transparent; color: transparent; caret-color: #c9d1d9;
    z-index: 1; resize: none; -webkit-text-fill-color: transparent;
}
.kw  { color: #ff7b72; }
.ty  { color: #79c0ff; }
.fn  { color: #d2a8ff; }
.num { color: #79c0ff; }
.str { color: #a5d6ff; }
.cm  { color: #8b949e; font-style: italic; }
.pr  { color: #ffa657; font-weight: 600; }
.op  { color: #ff7b72; }
.viz-panel {
    padding: 16px; display: flex; flex-direction: column; gap: 12px;
    overflow: auto;
}
.stats-bar {
    display: flex; gap: 32px; padding: 8px 0;
}
.stat .label { font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; }
.stat .value { font-size: 18px; font-weight: 700; color: #58a6ff; font-variant-numeric: tabular-nums; }
.card {
    background: #161b22; border: 1px solid #21262d; border-radius: 8px;
    padding: 12px; display: flex; flex-direction: column; gap: 8px;
}
.card-title {
    font-size: 11px; color: #8b949e; text-transform: uppercase;
    letter-spacing: 1px;
}
.heatmap-wrap { position: relative; width: 100%; overflow: auto; }
#cv-heatmap { display: block; }
.tooltip {
    position: fixed; background: #161b22; border: 1px solid #30363d;
    border-radius: 6px; padding: 8px 12px; font-size: 12px;
    pointer-events: none; z-index: 100; display: none;
    font-family: 'SF Mono', 'JetBrains Mono', monospace;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.tooltip .t-names { color: #58a6ff; font-weight: 600; }
.tooltip .t-val   { color: #7ee787; font-size: 14px; }
.tooltip .t-prefs { color: #8b949e; font-size: 11px; margin-top: 4px; }
.console-out {
    font-family: 'SF Mono', 'JetBrains Mono', monospace;
    font-size: 11px; line-height: 1.5; color: #8b949e;
    max-height: 250px; overflow-y: auto; white-space: pre;
    padding: 8px; background: #0d1117; border-radius: 4px;
    border: 1px solid #21262d;
}
.js-toggle {
    font-size: 11px; color: #58a6ff; cursor: pointer; user-select: none;
    padding: 4px 0;
}
.js-toggle:hover { text-decoration: underline; }
.js-output {
    font-family: 'SF Mono', 'JetBrains Mono', monospace;
    font-size: 11px; line-height: 1.4; color: #7ee787;
    max-height: 200px; overflow-y: auto; white-space: pre;
    padding: 8px; background: #0d1117; border-radius: 4px;
    border: 1px solid #21262d; display: none;
}
.legend {
    display: flex; align-items: center; gap: 8px; font-size: 11px; color: #8b949e;
    margin-top: 4px;
}
.legend-bar {
    width: 120px; height: 10px; border-radius: 3px;
    background: linear-gradient(to right, #1a1e2e, #1e3a5f, #3b82f6, #f59e0b, #ef4444);
}
.ranking-list {
    display: grid; grid-template-columns: 1fr 1fr; gap: 4px 20px;
    font-family: 'SF Mono', 'JetBrains Mono', monospace; font-size: 12px;
    max-height: 200px; overflow-y: auto;
}
.rank-row { display: flex; gap: 8px; padding: 2px 0; }
.rank-pos   { color: #8b949e; min-width: 24px; }
.rank-names { color: #c9d1d9; flex: 1; }
.rank-val   { font-weight: 600; min-width: 48px; text-align: right; }
</style>
</head>
<body>

<div class="tooltip" id="tooltip">
    <div class="t-names" id="tip-names"></div>
    <div class="t-val" id="tip-val"></div>
    <div class="t-prefs" id="tip-prefs"></div>
</div>

<main>
    <section class="code-panel">
        <div class="panel-header">
            <span class="title">vacanze_set.dx</span>
            <span class="badge badge-live">LIVE</span>
        </div>
        <div class="editor-wrap">
            <pre class="editor-highlight" id="editor-highlight"></pre>
            <textarea class="editor-textarea" id="source-editor" spellcheck="false"></textarea>
        </div>
    </section>

    <section class="viz-panel">
        <div class="controls">
            <button id="btn-run">Esegui</button>
        </div>

        <div class="stats-bar">
            <div class="stat">
                <div class="label">Persone</div>
                <div class="value" id="stat-persons">&mdash;</div>
            </div>
            <div class="stat">
                <div class="label">Coppie</div>
                <div class="value" id="stat-pairs">&mdash;</div>
            </div>
            <div class="stat">
                <div class="label">Tempo</div>
                <div class="value" id="stat-time">&mdash;</div>
            </div>
            <div class="stat">
                <div class="label">Stato</div>
                <div class="value" id="stat-status" style="color:#8b949e">Pronto</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Matrice di Similarit&#224; (cosine similarity)</div>
            <div class="legend">
                <span>0.0</span>
                <div class="legend-bar"></div>
                <span>1.0</span>
            </div>
            <div class="heatmap-wrap">
                <canvas id="cv-heatmap"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Classifica Coppie Pi&#249; Simili</div>
            <div class="ranking-list" id="ranking"></div>
        </div>

        <div class="card">
            <div class="card-title">Console</div>
            <div class="js-toggle" id="js-toggle">&#9654; Mostra JS generato</div>
            <div class="js-output" id="js-output"></div>
            <div class="console-out" id="console-out"></div>
        </div>
    </section>
</main>

<script>
// ================================================================
// DX SOURCE
// ================================================================
var DX_SOURCE = "-- Cosine Similarity demo: preferenze vacanziere (versione set + choose)\n-- Ogni persona esprime preferenza da 1 a 10 per: [mare, montagna, citta, campagna]\n\nmario : [9 2 3 1]\nluigi : [8 3 2 2]\npeach : [2 1 9 3]\ntoad : [3 9 1 8]\nyoshi : [7 4 5 2]\nbowser : [1 8 2 9]\ndaisy : [9 1 8 1]\nrosalina : [3 2 9 7]\nwario : [5 5 5 5]\nwaluigi : [1 9 3 7]\nbirdo : [8 2 7 1]\nkamek : [2 7 1 9]\nshyguy : [4 6 3 8]\nboo : [1 3 8 6]\nkoopa : [6 8 2 4]\ntoadette : [7 3 6 3]\npauline : [3 1 10 2]\nnabbit : [5 7 4 6]\nspike : [2 9 1 7]\nchunky : [10 1 1 1]\n\npersons : {mario, luigi, peach, toad, yoshi, bowser, daisy, rosalina,\n           wario, waluigi, birdo, kamek, shyguy, boo, koopa, toadette,\n           pauline, nabbit, spike, chunky}\n\nprint(\"=== Preferenze Vacanziere (cosine similarity) ===\")\nprint(\"  [mare, montagna, citta, campagna]\")\n\nfor (person1, person2) in persons'choose(2)\n  sim : person1 ~ person2\n  print(\"{person1''name} ~ {person2''name} = {sim}\")";

// ================================================================
// SYNTAX HIGHLIGHTING
// ================================================================
function highlightDx(code) {
    var h = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return h.split('\n').map(function(line) {
        var cmIdx = line.indexOf('--');
        var cp = cmIdx >= 0 ? line.slice(0, cmIdx) : line;
        var cm = cmIdx >= 0 ? '<span class="cm">' + line.slice(cmIdx) + '</span>' : '';
        cp = cp.replace(/("(?:[^"\\]|\\.)*?")/g, '<span class="str">$1</span>');
        cp = cp.replace(/\b(type|fun|for|if|in|print|return)\b/g, '<span class="kw">$1</span>');
        cp = cp.replace(/\b(Vec|Tensor|Float|Int|String|Set)\b/g, '<span class="ty">$1</span>');
        cp = cp.replace(/\b(it|me)\b/g, '<span class="pr">$1</span>');
        cp = cp.replace(/ \. /g, ' \u00b7 ');
        cp = cp.replace(/\b(\d+\.?\d*)\b/g, '<span class="num">$1</span>');
        return cp + cm;
    }).join('\n');
}

function syncHighlight() {
    var ta = document.getElementById('source-editor');
    var pre = document.getElementById('editor-highlight');
    pre.innerHTML = highlightDx(ta.value) + '\n';
}

function syncScroll() {
    var ta = document.getElementById('source-editor');
    var pre = document.getElementById('editor-highlight');
    pre.scrollTop = ta.scrollTop;
    pre.scrollLeft = ta.scrollLeft;
}

// ================================================================
// STATE
// ================================================================
var consoleLines = [];
var simData = [];
var personNames = [];
var personPrefs = {};

function logLine(text) {
    consoleLines.push(text);
    if (consoleLines.length > 500) consoleLines.shift();
    var el = document.getElementById('console-out');
    el.textContent = consoleLines.join('\n');
    el.scrollTop = el.scrollHeight;
}

// ================================================================
// COSINE SIMILARITY
// ================================================================
function cosineSimilarity(a, b) {
    var dot = 0, na = 0, nb = 0;
    for (var i = 0; i < a.length; i++) {
        dot += a[i] * b[i];
        na += a[i] * a[i];
        nb += b[i] * b[i];
    }
    return na > 0 && nb > 0 ? dot / (Math.sqrt(na) * Math.sqrt(nb)) : 0;
}

function parsePersons(source) {
    var persons = [];
    var prefs = {};
    var lines = source.split('\n');
    for (var i = 0; i < lines.length; i++) {
        var m = lines[i].match(/^(\w+)\s*:\s*\[([^\]]+)\]/);
        if (m) {
            var name = m[1];
            var vals = m[2].trim().split(/\s+/).map(Number);
            if (vals.length > 0 && !isNaN(vals[0])) {
                persons.push({ name: name, vals: vals });
                prefs[name] = vals;
            }
        }
    }
    // Extract set ordering
    var setMatch = source.match(/\{([^}]+)\}/);
    var ordered = [];
    if (setMatch) {
        ordered = setMatch[1].split(',').map(function(s) { return s.trim(); }).filter(Boolean);
    }
    if (ordered.length === 0) ordered = persons.map(function(p) { return p.name; });
    return { persons: persons, prefs: prefs, ordered: ordered };
}

// ================================================================
// HEATMAP
// ================================================================
var COLORS = [
    [26, 30, 46],
    [30, 58, 95],
    [59, 130, 246],
    [245, 158, 11],
    [239, 68, 68],
];

function simColor(v) {
    v = Math.max(0, Math.min(1, v));
    var t = v * (COLORS.length - 1);
    var i = Math.min(Math.floor(t), COLORS.length - 2);
    var frac = t - i;
    var c0 = COLORS[i], c1 = COLORS[i + 1];
    return [
        Math.round(c0[0] + (c1[0] - c0[0]) * frac),
        Math.round(c0[1] + (c1[1] - c0[1]) * frac),
        Math.round(c0[2] + (c1[2] - c0[2]) * frac),
    ];
}

function drawHeatmap() {
    if (personNames.length === 0) return;
    var N = personNames.length;
    var cellSize = Math.max(22, Math.min(36, Math.floor(600 / N)));
    var labelW = 72, labelH = 72;
    var w = labelW + N * cellSize;
    var h = labelH + N * cellSize;

    var cv = document.getElementById('cv-heatmap');
    var dpr = window.devicePixelRatio || 1;
    cv.width = Math.round(w * dpr);
    cv.height = Math.round(h * dpr);
    cv.style.width = w + 'px';
    cv.style.height = h + 'px';
    var ctx = cv.getContext('2d');
    ctx.scale(dpr, dpr);

    // Build matrix
    var matrix = [];
    for (var i = 0; i < N; i++) {
        matrix[i] = new Float32Array(N);
        matrix[i][i] = 1.0;
    }
    for (var si = 0; si < simData.length; si++) {
        var d = simData[si];
        var ri = personNames.indexOf(d.name1);
        var ci = personNames.indexOf(d.name2);
        if (ri >= 0 && ci >= 0) {
            matrix[ri][ci] = d.sim;
            matrix[ci][ri] = d.sim;
        }
    }

    ctx.fillStyle = '#0d1117';
    ctx.fillRect(0, 0, w, h);

    // Cells
    for (var row = 0; row < N; row++) {
        for (var col = 0; col < N; col++) {
            var v = matrix[row][col];
            var rgb = simColor(v);
            var cx = labelW + col * cellSize;
            var cy = labelH + row * cellSize;
            ctx.fillStyle = 'rgb(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ')';
            ctx.fillRect(cx + 0.5, cy + 0.5, cellSize - 1, cellSize - 1);
            if (cellSize >= 30) {
                ctx.fillStyle = v > 0.6 ? '#000' : '#fff';
                ctx.font = Math.max(8, cellSize / 4) + 'px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(v.toFixed(2), cx + cellSize / 2, cy + cellSize / 2);
            }
        }
    }

    // Row labels
    ctx.fillStyle = '#c9d1d9';
    ctx.font = '11px -apple-system, sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for (var i = 0; i < N; i++) {
        ctx.fillText(personNames[i], labelW - 6, labelH + i * cellSize + cellSize / 2);
    }

    // Column labels (rotated)
    ctx.textAlign = 'left';
    for (var i = 0; i < N; i++) {
        ctx.save();
        ctx.translate(labelW + i * cellSize + cellSize / 2, labelH - 6);
        ctx.rotate(-Math.PI / 3);
        ctx.fillText(personNames[i], 0, 0);
        ctx.restore();
    }

    // Store for tooltip
    cv._matrix = matrix;
    cv._cellSize = cellSize;
    cv._labelW = labelW;
    cv._labelH = labelH;
    cv._N = N;
}

// ================================================================
// TOOLTIP
// ================================================================
function setupTooltip() {
    var cv = document.getElementById('cv-heatmap');
    var tip = document.getElementById('tooltip');
    var cats = ['mare', 'montagna', 'citta', 'campagna'];

    cv.addEventListener('mousemove', function(e) {
        if (!cv._matrix) return;
        var rect = cv.getBoundingClientRect();
        var mx = e.clientX - rect.left;
        var my = e.clientY - rect.top;
        var col = Math.floor((mx - cv._labelW) / cv._cellSize);
        var row = Math.floor((my - cv._labelH) / cv._cellSize);

        if (col >= 0 && col < cv._N && row >= 0 && row < cv._N) {
            var n1 = personNames[row], n2 = personNames[col];
            var val = cv._matrix[row][col];
            document.getElementById('tip-names').textContent = n1 + ' ~ ' + n2;
            document.getElementById('tip-val').textContent = 'cosine similarity = ' + val.toFixed(4);
            var prefText = '';
            if (personPrefs[n1]) prefText += n1 + ': [' + personPrefs[n1].join(', ') + ']\n';
            if (personPrefs[n2]) prefText += n2 + ': [' + personPrefs[n2].join(', ') + ']';
            if (cats.length) prefText += '\n(' + cats.join(', ') + ')';
            document.getElementById('tip-prefs').textContent = prefText;
            tip.style.display = 'block';
            tip.style.left = (e.clientX + 14) + 'px';
            tip.style.top = (e.clientY + 14) + 'px';
        } else {
            tip.style.display = 'none';
        }
    });
    cv.addEventListener('mouseleave', function() { tip.style.display = 'none'; });
}

// ================================================================
// RANKING
// ================================================================
function drawRanking() {
    var sorted = simData.slice().sort(function(a, b) { return b.sim - a.sim; });
    var el = document.getElementById('ranking');
    var top = sorted.slice(0, 20);
    var bottom = sorted.slice(-10).reverse();

    var html = '<div style="grid-column:1/-1;color:#7ee787;font-size:11px;font-weight:600;margin-bottom:2px">TOP 20 - Pi\u00f9 simili</div>';
    for (var i = 0; i < top.length; i++) {
        var d = top[i];
        var rgb = simColor(d.sim);
        html += '<div class="rank-row"><span class="rank-pos">' + (i + 1) + '.</span><span class="rank-names">' + d.name1 + ' ~ ' + d.name2 + '</span><span class="rank-val" style="color:rgb(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ')">' + d.sim.toFixed(4) + '</span></div>';
    }

    html += '<div style="grid-column:1/-1;color:#f85149;font-size:11px;font-weight:600;margin:8px 0 2px">BOTTOM 10 - Pi\u00f9 diversi</div>';
    for (var i = 0; i < bottom.length; i++) {
        var d = bottom[i];
        var rgb = simColor(d.sim);
        html += '<div class="rank-row"><span class="rank-pos">' + (sorted.length - bottom.length + bottom.length - i) + '.</span><span class="rank-names">' + d.name1 + ' ~ ' + d.name2 + '</span><span class="rank-val" style="color:rgb(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ')">' + d.sim.toFixed(4) + '</span></div>';
    }
    el.innerHTML = html;
}

// ================================================================
// RUN
// ================================================================
function compileAndRun() {
    var source = document.getElementById('source-editor').value;
    consoleLines = [];
    simData = [];
    personNames = [];
    personPrefs = {};

    var t0 = performance.now();
    var parsed = parsePersons(source);
    var persons = parsed.persons;
    personNames = parsed.ordered;
    personPrefs = parsed.prefs;

    logLine('=== Preferenze Vacanziere (cosine similarity) ===');
    logLine('  [mare, montagna, citta, campagna]');
    logLine('');

    // Build JS output
    var jsLines = ['// Generato dal sorgente dx\n'];
    for (var i = 0; i < persons.length; i++) {
        jsLines.push('const ' + persons[i].name + ' = [' + persons[i].vals.join(', ') + '];');
    }
    jsLines.push('\nfunction cosSim(a, b) {');
    jsLines.push('    let dot = 0, na = 0, nb = 0;');
    jsLines.push('    for (let i = 0; i < a.length; i++) {');
    jsLines.push('        dot += a[i]*b[i]; na += a[i]*a[i]; nb += b[i]*b[i];');
    jsLines.push('    }');
    jsLines.push('    return dot / (Math.sqrt(na) * Math.sqrt(nb));');
    jsLines.push('}\n');

    // Compute all pairs (choose 2)
    var pMap = {};
    for (var i = 0; i < persons.length; i++) pMap[persons[i].name] = persons[i].vals;

    for (var i = 0; i < personNames.length; i++) {
        for (var j = i + 1; j < personNames.length; j++) {
            var n1 = personNames[i], n2 = personNames[j];
            var v1 = pMap[n1], v2 = pMap[n2];
            if (!v1 || !v2) continue;
            var sim = cosineSimilarity(v1, v2);
            simData.push({ name1: n1, name2: n2, sim: sim });
            logLine(n1 + ' ~ ' + n2 + ' = ' + sim.toFixed(4));
            jsLines.push('console.log(' + n1 + ' + " ~ " + ' + n2 + ' + " = " + cosSim(' + n1 + ', ' + n2 + ').toFixed(4));');
        }
    }

    var dt = (performance.now() - t0).toFixed(0);
    document.getElementById('js-output').textContent = jsLines.join('\n');

    // Stats
    document.getElementById('stat-persons').textContent = personNames.length;
    document.getElementById('stat-pairs').textContent = simData.length;
    document.getElementById('stat-time').textContent = dt + 'ms';
    document.getElementById('stat-status').textContent = 'Completato';
    document.getElementById('stat-status').style.color = '#22c55e';

    drawHeatmap();
    drawRanking();

    document.getElementById('btn-run').textContent = 'Esegui';
    document.getElementById('btn-run').disabled = false;
}

// ================================================================
// INIT
// ================================================================
function init() {
    var ta = document.getElementById('source-editor');
    ta.value = DX_SOURCE;
    syncHighlight();
    ta.addEventListener('input', syncHighlight);
    ta.addEventListener('scroll', syncScroll);
    ta.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            var start = ta.selectionStart, end = ta.selectionEnd;
            ta.value = ta.value.substring(0, start) + '    ' + ta.value.substring(end);
            ta.selectionStart = ta.selectionEnd = start + 4;
            syncHighlight();
        }
    });

    // JS toggle
    document.getElementById('js-toggle').addEventListener('click', function() {
        var el = document.getElementById('js-output');
        var toggle = document.getElementById('js-toggle');
        if (el.style.display === 'none' || !el.style.display) {
            el.style.display = 'block';
            toggle.innerHTML = '&#9660; Nascondi JS generato';
        } else {
            el.style.display = 'none';
            toggle.innerHTML = '&#9654; Mostra JS generato';
        }
    });

    setupTooltip();

    // Run button
    document.getElementById('btn-run').addEventListener('click', function() {
        document.getElementById('btn-run').textContent = 'Calcolo...';
        document.getElementById('btn-run').disabled = true;
        document.getElementById('stat-status').textContent = 'Calcolo...';
        document.getElementById('stat-status').style.color = '#d2a8ff';
        document.getElementById('console-out').textContent = '';
        setTimeout(compileAndRun, 20);
    });

    // Resize
    window.addEventListener('resize', function() {
        if (personNames.length > 0) drawHeatmap();
    });

    // Auto-run on load
    setTimeout(compileAndRun, 100);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
